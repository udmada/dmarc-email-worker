compatibility_flags = ["nodejs_compat"]
compatibility_date = "2026-02-04"

name = "dmarc-email-worker"
main = "src/index.ts"

[vars]
# SENDER_EMAIL = "reports@yourdomain.com" # Replace with your sender email
# SENDER_DOMAIN = "yourdomain.com" # Replace with your domain

# Analytics Engine for real-time metrics
[[analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "dmarc_reports"

# D1 Database for report storage
[[d1_databases]]
binding = "DB"
database_name = "dmarc_reports"
# database_id = "YOUR_D1_DATABASE_ID" # Replace with your D1 database ID

# Hyperdrive for PostgreSQL connection pooling (optional)
# [[hyperdrive]]
# binding = "HYPERDRIVE"
# id = "YOUR_HYPERDRIVE_ID"  # Replace with your Hyperdrive config ID

# Delete legacy ReplyQueue Durable Object (migrated to Queues)
[durable_objects]
bindings = []
[[migrations]]
tag = "v1"
new_sqlite_classes = ["ReplyQueue"]
[[migrations]]
tag = "v2"
deleted_classes = ["ReplyQueue"]

# Queue for delayed reply emails
[[queues.producers]]
binding = "EMAIL_QUEUE"
queue = "dmarc-reply-emails"

[[queues.consumers]]
queue = "dmarc-reply-emails"
max_batch_size = 10
max_retries = 5
dead_letter_queue = "dmarc-reply-emails-dlq"

# Email Sending capability (optional, used with reply queue)
[[send_email]]
name = "EMAIL"

# Rate Limiting
[[unsafe.bindings]]
name = "RATE_LIMIT"
type = "ratelimit"
namespace_id = "10021"
simple = { limit = 100, period = 60 }

# Legacy R2 bucket (kept for backwards compatibility)
[[r2_buckets]]
binding = "R2_BUCKET"
bucket_name = "dmarc-aggregates"
preview_bucket_name = "dmarc-aggregates"

[observability]
enabled = true
head_sampling_rate = 1

[observability.logs]
enabled = true
head_sampling_rate = 1
persist = true
invocation_logs = true

[observability.traces]
enabled = true
persist = true
head_sampling_rate = 1
